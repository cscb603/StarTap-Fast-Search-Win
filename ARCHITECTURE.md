# 星TAP 极速搜索 - 技术架构说明书

## 1. 整体架构

本项目采用 **Backend-as-a-Service** 模式：
- **GUI 层 (Rust + egui 0.30)**: 负责界面渲染、用户输入监听、结果展示及交互逻辑。
- **搜索层 (es.exe CLI)**: 负责与 Everything 引擎通讯。通过 `es.exe` 执行命令行查询，获取 TSV 格式结果。
- **数据层 (Rust)**: 负责 TSV 结果的高性能解析、内存排序、别名映射及搜索习惯记忆。

---

## 2. 核心技术细节

### 2.1 高性能解析 (TSV 模式)
为了避免 `es.exe` 默认输出在处理带空格路径、缺失后缀名时的不稳定性，我们强制使用了 `-tsv` 格式。
- **格式**: `文件名 \t 大小`
- **优势**: 字段分隔明确，解析速度比正则快 5-10 倍。
- **代码实现**: 见 `searcher.rs` 中的 `parse_es_output` 函数。

### 2.2 编码智能检测
Windows 环境下文件路径可能存在 UTF-8 或 GBK 两种编码。
- **逻辑**: 优先尝试 UTF-8 解码，若出现非法字符（had_errors），则自动回退至 GBK 编码。
- **库支持**: `encoding_rs`。

### 2.3 主题系统
为了实现“不脏且高级”的视觉效果：
- **白昼模式 (Light)**: 采用经典蓝白配色，浅蓝背景 + 深蓝高亮 + 黑色文字，搜索词高亮为标准橙色。
- **暗夜模式 (Dark)**: 保持原有深色配色。
- **智能时间切换**: 6:00-18:00 自动白昼模式，其他时间暗夜模式。
- **图标切换**: 使用 PNG 透明图标嵌入二进制，无需外部资源。
- **垂直对齐**: 标题栏采用偏移补偿算法，确保文字在视觉上垂直居中。

### 2.4 egui 0.30 升级 (2026-02-15)
**为什么升级？**
- 原生支持中文输入法 IME（候选词显示）
- 更好的窗口管理 API
- 更稳定的渲染性能

**兼容性变更：**
- `FontData` 现在需要用 `Arc` 包裹
- `Image::new()` 改为链式调用 `.fit_to_exact_size()`
- 字体数据结构调整

### 2.5 窗口显示逻辑（关键大坑）
**问题：** 使用 `Visible(false)` 隐藏窗口后，无法再显示出来。

**解决：** 完全移除 `Visible`，只用 `Minimized(true/false)`。

**3 轮 Focus 激活机制：**
```rust
// 第一轮：恢复窗口
ctx.send_viewport_cmd(egui::ViewportCommand::Minimized(false));
ctx.request_repaint();
std::thread::sleep(Duration::from_millis(50));

// 第二轮：聚焦
ctx.send_viewport_cmd(egui::ViewportCommand::Focus);
ctx.request_repaint();
std::thread::sleep(Duration::from_millis(50));

// 第三轮：保险再聚焦
ctx.send_viewport_cmd(egui::ViewportCommand::Focus);
```

### 2.6 资源嵌入二进制
使用 `include_bytes!` 宏在编译时将 PNG 图标嵌入到 exe 中：
```rust
let day_icon_data = include_bytes!("../assets/day_icon.png");
let day_image = image::load_from_memory(day_icon_data).unwrap().to_rgba8();
```

**好处：**
- 发布只需要一个 exe
- 无需外部图片文件
- 启动更快

### 2.7 稳定性与兼容性
- **IPC 轮询**: 启动时会尝试连接 Everything IPC，若未启动则自动唤起 `lib/Everything.exe` 并轮询 3 秒等待就绪。
- **路径鲁棒性**: 针对超长路径使用 Ellipsis (省略号) 处理，并支持右键一键复制完整路径。
- **窗口边缘检测**: 支持左/右/上/下/角落的调整大小光标指示。

---

## 3. 避坑指南 (经验总结)

### 3.1 egui 版本升级大坑
- **问题**: 从 0.29 升级到 0.30 时 API 有重大变化
- **FontData**: 需要用 `Arc` 包裹
- **Image**: 不再直接接受大小参数，需链式调用
- **Button::image**: 参数格式变化

### 3.2 命令行引号陷阱
直接将查询词传给 `es.exe` 可能会被系统错误包裹引号。
- **对策**: 使用 `shell-words` 库对查询参数进行精确拆分，确保 `es.exe` 接收到正确的参数列表。

### 3.3 分类过滤失效
曾出现 `ext:mp4;mkv 夏天` 搜不到结果的情况。
- **原因**: 参数组合顺序和空格处理不当。
- **对策**: 统一将过滤参数置于查询词前方，并确保空格分隔。

### 3.4 圆角黑边问题
在 Windows 透明窗口下，圆角边缘容易出现黑色杂点。
- **对策**: 移除外层描边，将 `margin` 设为极小值 (1px)，并配合 `shadow` 偏移量。

### 3.5 字符显示方框
特殊字符（长横线、emoji）在某些字体下显示为方框 □。
- **原因**: 加载的中文字体不包含这些字符。
- **对策**: 改用 PNG 透明图标代替文字。

### 3.6 输入法说明
- **当前状态**: egui 0.30 支持中文输入法，但中英文输入需切换对应输入法。
- **输入英文**: 请切到英文输入法。
- **输入中文**: 请切到中文输入法。
- **混合输入**: 暂不支持，需分开切换。

### 3.7 Clippy 强制执行
Rust 项目规模扩大后，死代码和冗余引用会严重干扰调试。
- **规范**: 每次编译前必须过 `cargo clippy`。

---

## 4. 目录结构说明

- `/src`: Rust 源代码。
  - `gui.rs`: 所有的 UI 布局和颜色定义、主题图标加载。
  - `searcher.rs`: 核心搜索逻辑和 TSV 解析。
  - `main.rs`: 托盘初始化与事件分发、窗口显示逻辑。
- `/lib`: 关键运行依赖 (Everything 核心)。
- `/assets`: 图标及静态资源（会被嵌入二进制）。
  - `day_icon.png`: 白昼主题图标
  - `night_icon.png`: 暗夜主题图标
- `/dist`: 准备分发的绿色版文件夹。

---

## 5. 版本历史

### v0.2.1 (2026-02-15) - 重大升级
- ✅ 升级 egui 0.29 → 0.30（支持中文 IME）
- ✅ 修复托盘「显示窗口」无响应（移除 Visible，只用 Minimized）
- ✅ 主题切换改用 PNG 透明图标（嵌入二进制）
- ✅ 智能时间主题（6:00-18:00 自动白昼）
- ✅ 浅色配色优化（经典蓝白+橙色高亮）
- ✅ 窗口边缘检测（调整大小光标）

---

*星TAP实验室 - 2026.02.15*
